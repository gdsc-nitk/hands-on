# オプション講座 - ネットワークコース

## はじめに

本講座では，基礎講座で製作したWebサーバについて，インターネットからのアクセスを有効化する方法を示します．

世界中に存在する悪意のあるユーザからの攻撃を受けるリスクがあります．  
決して個人情報や他人の著作物などを公開しないでください．

なお本コースに限り，**[セキュリティコース](opt-security.md)の内容を修了していることを前提条件**とします．  
本コース内容の実施を希望する方は，先にセキュリティコースのコマンドを一通り実行してからこちらへ戻ってきていただくようお願いいたします．

## リバースプロキシサービスの利用

本来，Webサーバの対外公開を行う場合は以下のような手順を踏む必要があります．

1. グローバルIPアドレス，ドメインを取得する．(有料)
1. ネットワーク機器を適切に設定し，外部との疎通を有効化する．
1. DNSサーバにレコードを登録し，グローバルIPアドレスとFQDN(ドメインを利用した文字列)を紐付ける．
1. Let's Encryptなどでサーバ証明書を取得し，httpsによる暗号化通信を可能とする．

しかし，ハンズオンイベントの中で行うにはいずれも少々荷の重い作業となります．  

よって今回は，ngrok(エングロック)というサービスを利用することで工程を端折って実施してみることにします．  
小規模な開発にはとても有用なサービスです．

## アクセストークンの取得

ngrokのアカウントを作成し，動作に必要なアクセストークンを入手します．

1. [こちら](https://dashboard.ngrok.com/signup)のページにアクセスし，アカウントを作成してください．  
下部のボタンから，GitHubアカウントやGoogleアカウントを利用して登録しても構いません．

2. アカウントの作成ができたら，[こちら](https://dashboard.ngrok.com)のページにアクセスしてログインします．

3. 左側メニューから，**Your Authtoken**をクリックします．  
もし表示されていなければ，**Getting Started**のすぐ右にあるボタンを押し，メニューを展開してみてください．

4. 画面右側に現れる 青い**Copy**を押します．

これで，クリップボードにアクセストークンがコピーされました．

アクセストークンはパスワードと概ね同様の働きをします．  
決して他人に教えたり，他人が見ることのできる領域に保存したりしないよう注意してください．

## ngrokの導入

1. ngrok本体をダウンロードします．
```
wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-arm.zip
```

2. ダウンロードしたファイルを解凍します．
```
unzip ngrok-stable-linux-arm.zip
```

3. 実行ファイルを，OS標準のディレクトリへ移動します．
```
sudo mv ngrok /usr/local/bin/
```

4. アクセストークンを設定します．  
このとき，`ngrok authtoken`のあとに半角スペースを入れた上で，先ほどコピーしたアクセストークンを貼り付けて実行してください．
`{ `や` }`は不要です．
```
ngrok authtoken {取得したAuthToken}
```

以上で設定完了です．

## 開通

それでは，WebサーバであるNginxが動作している80番ポートを公開してみます．  
以降，sudoは必要ありません．  
もしrootユーザで作業している場合は，`exit`コマンドを実行して一般ユーザに戻ってから以下を実行してください．

1. 以下のコマンドを実行してください．
```
ngrok http 80
```

2. 出力された文字列の中から，以下に該当する行を探します．  
```
Forwarding  http://~~~/ngrok.io -> http://localhost:80
Forwarding  https://~~~/ngrok.io -> http://localhost:80
```

このうち，`http://~~~/ngrok.io`の部分をChromeなどのブラウザに貼り付けて開いてみてください．  
正常に表示されていれば，OKです．

同様にして`https://~~~/ngrok.io`の方も開いてみると，httpsを利用した暗号化通信が行われていることが確認できます．

## おわりに

ngrokを利用し，簡潔に外部からのアクセスを受けられるようにしました．  
今回の演習，お楽しみいただけたでしょうか．  
これで，手元の環境で開発したWebアプリケーションをインターネットに公開できます．  

なお冒頭にも示しましたが，サーバをインターネット上に公開する行為には相応のリスクが伴います．  
いつ，どこから，どのような攻撃が来るか分かりません．  
どれだけ気をつけて開発・運用していたとしても，常に未知の脆弱性を突かれる可能性を孕んでいます．  

十分な知識と技術を手にするまでは，

- 漏洩すると困るデータをサーバに保存しないこと
- 確認を終えたら都度，対外接続を切断すること

をおすすめします．

お疲れさまでした．